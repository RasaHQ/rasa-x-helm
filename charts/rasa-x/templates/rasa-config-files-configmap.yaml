apiVersion: "v1"
kind: "ConfigMap"
metadata:
  name: {{ template "rasa-x.rasa.configuration-files" . }}
  labels:
    {{ include "rasa-x.labels" . | nindent 4 }}
data:
  rasa-credentials: |
    rasa:
      url: {{ .Values.rasax.scheme }}://{{ include "rasa-x.host" . }}.{{ .Release.Namespace }}.svc:{{ .Values.rasax.port }}/api
    {{- with .Values.rasa.additionalChannelCredentials }}
    {{ toYaml . | nindent 4 }}
    {{- end }}
  rasa-endpoints: |
    models:
      url: ${RASA_MODEL_SERVER}
      token: ${RASA_X_TOKEN}
      wait_time_between_pulls: 10
    tracker_store:
      type: sql
      dialect: "postgresql"
      url: {{ template "rasa-x.psql.host" . }}
      port: {{ template "rasa-x.psql.port" . }}
      username: {{ template "rasa-x.psql.username" . }}
      password: ${DB_PASSWORD}
      db: ${DB_DATABASE}
      {{- if .Values.rasa.useLoginDatabase }}
      login_db: {{ template "rasa-x.psql.database" . }}
      {{- end }}
    event_broker:
      type: "kafka"
      security_protocol: "{{ .Values.kafka.security_protocol }}"
      topic: "{{ .Values.kafka.topic }}"
      url: "{{ .Values.kafka.url }}"
      sasl_username: "{{ .Values.kafka.sasl_username }}"
      sasl_password: "{{ .Values.kafka.sasl_password }}"
    action_endpoint:
      url: "{{ .Values.app.scheme }}://{{ include "rasa-x.fullname" . }}-app.{{ .Release.Namespace }}.svc:{{ template "rasa-x.custom-actions.port" . }}{{ .Values.app.endpoints.actionEndpointUrl }}"
      token:  ""
    {{- if $.Values.redis.install }}
    lock_store:
      type: "redis"
      url: {{ template "rasa-x.redis.host" . }}
      port: {{ default 6379 .Values.redis.redisPort }}
      password: ${REDIS_PASSWORD}
      db: {{ default "1" .Values.rasa.lockStoreDatabase }}
    {{- end }}
    {{- with .Values.rasa.additionalEndpoints }}
    {{ toYaml . | nindent 4 }}
    {{- end }}
