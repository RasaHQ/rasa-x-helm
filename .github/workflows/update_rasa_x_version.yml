name: Update Rasa X version

on:
  schedule:
    # Run once a day at 08:00
    - cron: '0 8 * * *'
  workflow_dispatch: {}

env:
  RASABOT_GITHUB_TOKEN: ${{ secrets.RASABOT_GITHUB_TOKEN }}
  RASABOT_USERNAME: Roberto
  RASABOT_EMAIL: 43567378+rasabot@users.noreply.github.com


jobs:
  open_pull_request:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python 3.7 üêç
        uses: actions/setup-python@v1
        with:
          python-version: 3.7

      - name: Checkout rasa-x-helm github repository üïù
        uses: actions/checkout@v2
        with:
          # The workflow needs to push to a new branch that changes a workflow file.
          # To do this, we need the rasabot service account.
          token: ${{ env.RASABOT_GITHUB_TOKEN }}


      - name: Get latest Rasa X minor üè∑
        run: |
          DOCKERHUB_TAGS_URL="https://registry.hub.docker.com/v2/repositories/rasa/rasa-x/tags?page_size=10000"
          LATEST_RASA_X_MINOR=$(curl -s ${DOCKERHUB_TAGS_URL} | jq -r '.results[].name' | grep -vE 'refs|aws|latest|stable|master|ls|list' | sort -Vr | head -n1 | sed 's/[a-z].*//')

          echo "Latest Rasa X minor: ${LATEST_RASA_X_MINOR}"
          echo "LATEST_RASA_X_MINOR=${LATEST_RASA_X_MINOR}" >> $GITHUB_ENV

      - name: Compare latest Rasa X minor with rasa-x-helm version ‚èØ
        run: |
          # Get current rasa-x version in Chart.yaml using yq
          pip3 install yq
          CURRENT_CHART_RASA_X_VERSION=$(yq .appVersion charts/rasa-x/Chart.yaml | sed 's/\"//g')

          echo "Current Chart Rasa X version: ${CURRENT_CHART_RASA_X_VERSION}"
          echo "Latest Rasa X minor: ${LATEST_RASA_X_MINOR}"

          if [[ ${LATEST_RASA_X_MINOR} == ${CURRENT_CHART_RASA_X_VERSION} ]]
          then
            echo "Version is good. Nothing to update."
            echo "CREATE_UPDATE_PR=false" >> $GITHUB_ENV
          else
            echo "Version does not match. Bumping it now."
            echo "CREATE_UPDATE_PR=true" >> $GITHUB_ENV
          fi

      - name: Get branch name ‚úçÔ∏è
        id: get-branch-name
        if: env.CREATE_UPDATE_PR == 'true'
        run: |
          echo "::set-output name=new_branch::bump-rasa-x-version-to-${LATEST_RASA_X_MINOR}-${GITHUB_SHA:0:7}"

      - name: Create new branch üê£
        uses: peterjgrainger/action-create-branch@v2.0.1
        if: env.CREATE_UPDATE_PR == 'true'
        env:
          GITHUB_TOKEN: ${{ env.RASABOT_GITHUB_TOKEN }}
        with:
          branch: ${{ steps.get-branch-name.outputs.new_branch }}

      - name: Update Chart YAML containing Rasa X version tags üóÇ
        if: env.CREATE_UPDATE_PR == 'true'
        run: |
          git config user.name ${{ env.RASABOT_USERNAME }}
          git config user.email ${{ env.RASABOT_EMAIL }}

          git remote update origin --prune
          git checkout ${{ steps.get-branch-name.outputs.new_branch }}

          sed -i "s/^appVersion.*/appVersion: \"${LATEST_RASA_X_MINOR}\"/" charts/rasa-x/Chart.yaml

          git add -u
          git commit -m "bump rasa-x version to ${LATEST_RASA_X_MINOR}"
          git push origin ${{ steps.get-branch-name.outputs.new_branch }}

      - name: Open pull request ‚òÑÔ∏è
        uses: repo-sync/pull-request@v2
        if: env.CREATE_UPDATE_PR == 'true'
        with:
          github_token: ${{ env.RASABOT_GITHUB_TOKEN }}
          source_branch: ${{ steps.get-branch-name.outputs.new_branch }}
          destination_branch: master
          pr_title: Bump Rasa X version to ${LATEST_RASA_X_MINOR}
