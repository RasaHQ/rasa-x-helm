name: Release Charts

on:
  push:
    branches:
    - master
    tags:
    - '**'

env:
  IS_TAG_BUILD: ${{ startsWith(github.event.ref, 'refs/tags') }

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    # See https://github.com/helm/chart-releaser-action/issues/6
    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

    - name: Add dependency chart repos
      run: |
        helm repo add bitnami https://charts.bitnami.com/bitnami

    - name: Run chart-releaser
      uses: helm/chart-releaser-action@v1.1.0
      env:
        CR_TOKEN: "${{ secrets.CR_TOKEN }}"

    - name: Publish Release Notes ðŸ—ž
      if: env.IS_TAG_BUILD
      env:
        GITHUB_TAG: ${{ github.ref }}
        GITHUB_REPO_SLUG: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TAG=${GITHUB_TAG/refs\/tags\//}
        sudo apt-get update
        sudo apt-get -y install pandoc
        pip install -U github3.py pep440_version_utils
        python3 ${GITHUB_WORKSPACE}/scripts/publish_gh_release_notes.py

    # TODO: clean changlog